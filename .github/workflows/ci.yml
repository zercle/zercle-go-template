name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Combined test and lint job with optimized caching
  validate:
    name: Test & Lint
    runs-on: ubuntu-latest

    # PostgreSQL service for integration tests
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: zercle_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
        cache: true
        cache-dependency-path: go.sum

    # Cache code generation tools to avoid reinstalling every run
    - name: Cache tools
      uses: actions/cache@v4
      with:
        path: ~/go/bin
        key: ${{ runner.os }}-go-tools-${{ hashFiles('**/go.mod') }}
        restore-keys: |
          ${{ runner.os }}-go-tools-

    - name: Download dependencies
      run: go mod download

    - name: Install code generation tools
      run: |
        if [ ! -f ~/go/bin/swag ]; then
          go install github.com/swaggo/swag/cmd/swag@latest
        fi

    - name: Generate code
      run: go generate ./...

    # Run linter and tests in parallel would be ideal, but linter needs generated code
    - name: Run linter
      uses: golangci/golangci-lint-action@v9
      with:
        version: v2.6
        args: --timeout=10m
        # Action has built-in caching

    - name: Build
      run: go build -v ./...

    - name: Run tests with coverage
      env:
        SERVER_ENV: dev
        DB_HOST: localhost
        DB_PORT: 5432
        DB_USER: postgres
        DB_PASSWORD: password
        DB_NAME: zercle_db
        DB_DRIVER: postgres
      run: |
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Build Docker image only on push to main
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate  # Only build if validation passes
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha

    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        # Use GitHub Actions cache for Docker layers
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Build with all available CPU cores
        build-args: |
          BUILDKIT_INLINE_CACHE=1
